---
title: "Tipping points in diversified farming systems" # changed from "diversifying" to "diversified".  if we're not going to use "agroecological" in the title, we should at least be consistent with the DFS language. if the aim was to convey the process of diversifying, maybe we could go for "Tipping points in diversified farming system adoption" - s.w. 6/2/20
author:
  - name: Melissa Chapman
    affiliation: espm
  - name: Serge Wiltshire
    affiliation: espm
  - name: Timothy Bowles
    affiliation: espm
  - name: Liz Carlisle
    affiliation: ucsb
  - name: Fredrico Castillo
    affiliation: espm
  - name: David Gonthier
    affiliation: ky
  - name: Alastair Iles
    affiliation: espm
  - name: Daniel Karp
    affiliation: davis
  - name: Claire Kremen
    affiliation: espm, ucb
  - name: Jeff Liebert
    affiliation: cornell
  - name: Elissa Olimpi
    affiliation: davis
  - name: Matthew Ryan
    affiliation: cornell
  - name: Amber Sciligo
    affiliation: organic
  - name: Jennifer Thompson
    affiliation: espm
  - name: Hannah Waterhouse
    affiliation: espm
  - name: Kenzo Eszquivel
    affiliation: espm
  - name: Sasha Gennet
    affiliation: tnc
  - name: Carl Boettiger
    affiliation: espm
    footnote: Corresponding Author
address:
  - code: espm
    address: "Dept. of Environmental Science, Policy, and Management, University of California Berkeley, Berkeley, CA, USA"
  - code: ubc
    address: "Institute of Resources, Environment and Sustainability, University of British Columbia, Vancouver, BC, Canada"
  - code: ucsb
    address: "Environmental Studies, University of California Santa Barbara, Santa Barbara, CA, USA"
  - code: davis
    address: "Wildlife, Fish, and Conservation Biology, University of California Davis, Davis, CA, USA"
  - code: ky
    address: "Dept. of Entomology, University of Kentucky, Lexington, KY, USA"
  - code: cornell
    address: "School of Integrated Plant Science, Cornell University, Cornell, NY, USA"
  - code: organic
    address: "The Organic Center, Washington, DC, USA"
  - code: tnc
    address: "The Nature Conservancy, Arlington, VA, USA" # added location of TNC HQ to match other entries
    
abstract: The emergence and impact of tipping points are of immense interest in both social and ecological research. Despite widespread recognition of the importance of feedbacks between human and natural systems, it is often assumed that the observed nonlinear dynamics in these coupled systems rest within either underlying human or natural processes. Using adoption of agricultural diversification practices as a case study, we show how bistability can emerge purely from temporal feedbacks between human decisions and ecological responses.  We propose that the mechanisms behind these dynamics have important implications for agricultural policy design. 

keywords:
  - agriculture,
  - ecosystem services,
  - tipping points,
  - diversification practices,
  - decision-making
bibliography: alt_stable_states.bib
date: "`r Sys.Date()`"
output: rticles::elsevier_article
layout: 3p # review # review = doublespace, 3p = singlespace, 5p = two-column
header-includes: 
  - \journal{TBD}
  - \graphicspath{{ext-figs/}}
  - \usepackage{float}
  - \linenumbers

---

```{r render_to_word_doc, include = FALSE, eval = FALSE}

# run this to generate a word doc
# not perfect, will have to format word doc after, but best I could come up with
library(rmarkdown)
render("dfs-mdp-manuscript.Rmd", word_document())

```


```{r setup, include = FALSE}
rm(list = ls(all.names = TRUE)) # clean environment

# load external scripts
source("../R/load-libraries.R")
source("../R/dfs-mdp-model.R")
source("../R/sim-plot-fxns.R")

knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      # eval = FALSE, # to knit faster - comment out to run code
                      fig.align = "center",
                      dev = "cairo_pdf")

pal <- solarized_pal()(7) # global color pallette
set.seed(4) # random seed
```

```{r model_def, include = FALSE}
# set up the MDP
actions <- seq(0, 1, length = 100)
states <- seq(0, 1.5, length = 100)
params <- list(
  benefit = 1.57, # changed from 1.56 to 1.57 to equalize distribution and help with fig 4 results
  cost = 1, 
  sigma = 0.1, 
  r = 0.1, 
  discount = 0.97, 
  Tmax = 20)
transition_fn <- function(s, a, params) s + params$r * (a - s)
utility_fn <- function(s, a, params) params$benefit * s - params$cost * a
model <- continuous_model(states, actions, params, transition_fn, utility_fn)

# solve the MDP
base_soln <- MDPtoolbox::mdp_value_iteration(model$P, model$U, params$discount)
base_soln_df <- tibble(state = states,
                       action = actions[base_soln$policy])

```

```{r global_sim_params, include = FALSE}
reps <- 500
init <- truncnorm::rtruncnorm(reps, 0, 1, 0.5, 0.2) %>% 
  map_int(function(x) which.min(abs(x - states)))

```


# Introduction

Both ecosystems and social systems have been observed to change states abruptly as the result of crossing a critical threshold. Theories of ecological multistability have long described this phenomenon [@scheffer2003catastrophic] and explored how ecological management impacts stability landscapes [@Horan7333], with tipping points assumed to stem from complex ecological processes like population dynamics [@mumby2007thresholds]. Similarly, examples of tipping points in social systems, ranging from the collapse of civilizations [@downey2016european] to social network processes such as the spread of innovations [@kuehn2014critical] suggest that these nonlinearities may result from complex features of human systems. Despite widespread interest in the mechanisms of tipping points in integrated socio-ecological systems, it has generally been assumed that the underlying nonlinear dynamics can be ascribed to either social processes *or* natural phenomena.

Empirically exploring tightly coupled social-environmental systems presents numerous research challenges [@kline2017integrating].  In such systems, human actions impact ecological processes, and the resultant changes create feedbacks that alter the scope and efficacy of future actions [@ostrom2009general; @walker2004resilience; @liu2007complexity].  For example, agricultural management choices can enhance or degrade ecological services that affect the long-term productive capacity of the land, impacting future financial returns, and limiting future decision possibilites [@zhang2007ecosystem].  Additionally, the temporal dynamics of ecological processes do not always align with the temporal scale of human decision-making.  For example, land management to promote ecosystem services may require sequential investments over time and/or take years to accrue [@morandin2016pest; @blaauw2014flower], meaning adoption of these practices requires decisionmakers to be forward looking, adaptive, and cognizant of environmental and economic dynamics and uncertainty. 

Agriculture is a fundamental driver of anthropogenic ecological change [@stoate2009ecological; @foley2005global; @foley2011solutions], providing a valuable context to examine how social and ecological systems interact. It is increasingly recognized that effective policies to promote agricultural sustainability require interdisciplinary approaches which consider both human decision-making and ecology as a coupled human-and-natural system [@liu2007complexity; @alberti2011research].  Here we use the adoption of diversified farming practices as a case study to explore such emergent properties [@kremen2012diversified].  In the context of diversified farming systems, diversification practices are defined as those that bolster ecosystem services by promoting beneficial agrobiodiversity, such as composting, intercropping, insectary strips, crop rotation, and cover cropping [@kremen2012diversified].  This definition of diversification is distinct from the concept of operational diversification (i.e. simply increasing the range of agricultural goods produced on a given farm).  Although existing research has explored how diversification practices affect ecological and financial outcomes [@rosa2019ecological], a deeper understanding  of the feedbacks between adoption of a given practice, resultant ecological change, and future decision landscapes is integral to informing policy design.  Such a framework opens space to analyze how diversified farming systems affect and are affected by ecosystem processes. 

Computational approaches to explore structural attributes of human-environment systems can suggest levers of change [@nicholson2019scenarios] and highlight important assumptions to explore empirically. While adoption of sustainable farm management, and more specifically diversification practices, undoubtable encompass a continuum of actions and outcomes, it is largely understood that these practices often coalesce around distinct stable states [@andow1989experimental; @vandermeer1997syndromes] and that fundamental shifts can occur from small changes in conditions when tipping points are reached  [@vandermeer2012syndromes].  While existing understanding of these dynamics rests on the assumption that the system , existing techniques to investigate dynamic ecological processes and responsive decision-making do not generally allow for forward-looking decision-makers [@lippe2019using] and may misrepresent the complex coupling of these systems.

This paper presents a stylized model of the adoption of diversification practices to explore the ecosystem patterns that result specifically from interactions between adaptive decision-making and an ever-changing environment.  We find a novel mechanism for bistability that is the result not of complex structural assumptions within either the human or natural system, but simply the rates at which the two systems interact over time.  While our model necessarily simplifies both decision-making and environmental processes, it provides a framework explore emergent properties in coupled human and natural systems.  Additionally, we suggest that our findings have important implications for agricultural policy design.

# Conceptual model description

We explore the transition to and from diversified farming systems using a Markov Decision Process in which a fruit/vegetable farmer makes a series of agroecological choices over time.  The model was developed through an iterative, participatory process in collaboration with an interdisciplinary team encompassing plant and soil scientists, agricultural economists, ecologists, agricultural policy experts, social scientists, and farmers.  The goal was to develop a stylized model that can be understood by a wide audience, while still capturing the core complexities stemming from the inherent coupled human and natural dynamics of the modeled system (Fig \ref{fig:res_conceptual}).  

Each season the farmer takes an "action" of 0\% to 100\% investment in adopting or maintaining diversification practices.  The "system state" coresponds to the level of benefit derived from the ecosystem services that result from those adoption decisions, and can include financial, social, ideological, and aesthetic considerations.  Higher actions correspond to a greater probability of transitioning to a higher (more beneficial) ecological state the next year.  While higher ecological states are beneficial, higher actions also come with a greater associated cost.  By defining parameter values for cost, benefit, transition stochastiticity, ecological change rate, and future discounting (values given in Methods, Tab \ref{tab:baseline_params}), we can calculate the optimal action strategy to be used by the agent based on expected rewards over either a definite or infinite time horizon.  

\begin{figure}
\centering 
\includegraphics[width=.75\textwidth]{external-figs/dfs_mdp_conceptual_fig.png}
\caption{Conceptual diagram of the Markov Decision Process model.  The farmer's choice of how much to invest (time and/or money) into diversification practices (DP) adoption is shown in blue, and the resulting ecosystem services (ES) state in green, with a more diversified state at the top, and a more simplified state at bottom.  Each year, the farmer chooses the optimal action for their current ES state based on the perceived utility function $(u)$ and the state transition probability function $(p)$.  $(p)$ describes how, for a given ES state and action at year $t$, the ecosystem responds stochastically at $t+1$.  The updated ES state then feeds back to influence the farmer's future choices, leading to complex tradeoffs arising from the coupling of ecological processes with consecutive DP adoption decisions over time.}
\label{fig:res_conceptual}
\end{figure}


# Results

Using the described model, we observe the behavior of agents' sequential choices and resultant environmental outcomes over time.  Agents' initial ecosystem states were distributed normally around a mean of $\bar{s} = 0.5$.  Fig \ref{fig:res_bimodal} shows that, after following the optimal decision strategy for 20 years, agents have largely settled into two groups, with some farms transitioning to more simplfied (conventional) farming systems, and others to more diversified (agroecological) systems.  Further, we find strong path dependency, with only 17\% of agents who started in a simplified ($s < 0.5$) state concluding in a diversified ($s > 0.5$) state, and only 7\% initially in the diversified state transitioning to simplified.


```{r base_case_sim, include = FALSE}
sim <- function(soln, 
                Tmax = params$Tmax,
                x0 = init){
  map_dfr(1:length(x0), 
          function(i) sim_mdp(model$P, model$U, soln$policy, params$discount, x0 = x0[i], Tmax = Tmax), 
          .id = "reps")
}
sims_baseline <- sim(base_soln)

# p_up_dn(sims_baseline)
```


```{r basline desnity}
sims_baseline %>% filter(time==0)  %>%
    ggplot() + geom_density(aes(state, group = time, fill = time, color = time), alpha=0.8) +
    coord_flip() +
    labs(x="", y="Density", fill="Time") +
    theme(axis.text.x=element_text(size=10),
          axis.text.y=element_blank(),
          axis.title.x=element_text(size=10),
          axis.title.y=element_text(size=10),
          legend.text = element_text(size=10),
          legend.title = element_text(size=10),
          legend.box.margin=margin(0,0,0,-5),
          plot.title = element_text(size = 10, face = "bold"),
          panel.grid.minor = element_blank())
```



```{r res_bimodal, fig.cap = "Initial ecosystem states are distributed normally (mean = 0.5; S.D. = 0.2; truncated at [0,1]).  Agents follow decision strategy $\\pi$ as shown in Fig \\ref{fig:res_strategy} until $t = 20$.  (A) Ecosystem state of each agent over time (500 simulations).  (B) Initial ES distribution (dark blue) and final bimodal distribution at $t = 20$ (light blue).", fig.width = 5, fig.asp = .6}

ggarrange(
  sim_plot_ts(sims_baseline, title = ggtitle("A. Timeseries"), rmarmod = -5), 
  sim_plot_dens(sims_baseline, title = ggtitle("B. Initial and final state"), 
                tpos = "panel", lab_lo_peak = TRUE, lab_hi_peak = TRUE, lmarmod = -5), 
  widths = c(2.75, 2), nrow = 1, ncol = 2
)

# p_up_dn(sims_baseline)
```

## Optimal decision strategy

The decision strategy $\pi$ describes the optimal course of action for a given state and is used by all agents across replicate simulations.  For the parameterization given in Tab \ref{tab:baseline_params}, and with an infinite time horizon, the resultant $\pi$ is shown in Fig \ref{fig:res_strategy}.  This reveals a tipping point at a specific ecosystem state, below which the highest expected value is derived by investing little to nothing into diversified farming systems, and above which the optimum action becomes near-full investment. Over time, this results in the bimodal distribution of ecosystem states seen in Fig \ref{fig:res_bimodal}. 

```{r res_strategy, fig.cap = "Optimal decision strategy $\\pi$ as a function of ES state, showing a tipping point at $s \\approx 0.52$.  The upper $x$ axis limit is the 99th percentile of observed states in our simulation results ($s \\approx 1.3$).", fig.width = 3, fig.asp = 1}

state99th <- sims_baseline %>% 
  mutate(state = states[state]) %>% 
  pull(state) %>% 
  quantile(.99) %>% 
  unname()
tpt <- 0
for(si in 1:length(states)-1) {
  if(base_soln_df$action[si] < .1 && base_soln_df$action[si+1] > .9) {
    tpt <- base_soln_df$state[si] + ((base_soln_df$state[2] - base_soln_df$state[1]) / 2)
  }
}

soln_plot(base_soln_df %>% filter(state <= state99th), tpt = tpt)

```



```{r res_bimodal2, fig.cap = "Initial ecosystem states are distributed normally (mean = 0.5; S.D. = 0.2; truncated at [0,1]).  Agents follow decision strategy $\\pi$ as shown in Fig \\ref{fig:res_strategy} until $t = 20$.  (A) Ecosystem state of each agent over time (500 simulations).  (B) Initial ES distribution (dark blue) and final bimodal distribution at $t = 20$ (light blue).", fig.width = 8, fig.height=3, dpi=500}

ggarrange(
  soln_plot(base_soln_df %>% filter(state <= state99th), tpt = tpt),
  sim_plot_ts(sims_baseline, title = ggtitle("C. Timeseries"), rmarmod = -5), 
  sim_plot_dens(sims_baseline, title = ggtitle("D. Initial and final state"), 
                tpos = "panel", lab_lo_peak = TRUE, lab_hi_peak = TRUE, lmarmod = -5), 
  widths = c(1.75,3.75,2.25), nrow = 1, ncol = 3
)

# p_up_dn(sims_baseline)
```
