---
title: "dfs-med manuscript scratchpad"
output: pdf_document
---

##pulled out of intro, didn't seem to fit
For example, community composition of birds and soil microbes jointly influence food safety through the incidence and suppression of foodborne pathogens, and are impacted by farm level decisions about practices. 

## Serge's original intro

In recent years, scholars have increasingly recognized that solutions to complex ecological policy issues often require an interdisciplinary approach, conceiving human decisionmaking and ecology as a tightly-enmeshed social-ecological system (SES) or coupled human and natural system (CHANS).  SES/CHANS analysis is appropriate wherever human agents make choices that impact the environment, and the resultant environmental change creates complex feedback loops that impinge upon the scope and efficacy of the human agent's future decisions \cite{ostrom2009general, walker2004resilience, liu2007complexity}.  Agriculture---being among the most fundamental drivers of anthropogenic ecological change \cite{stoate2009ecological}---represents a critical focus area to examine the core dynamical properties inherent to such human-environment nexuses.  While agriculture is often studied through a discipline-specific lens, in reality growers' management decisions---in particular those which promote functional biodiversity---have profound and complex effects on their local ecology, with these agronomic outcomes in turn embuing ecological services (ES) that affect the long-term productive capacity of their land base, and their resultant financial returns \cite{zhang2007ecosystem}.  

This study presents a Markov Decision Process (MDP) model \cite{clark1989bioeconomic} that explores produce production in the central coast region of California through an SES framework.  We focus on Diversified Farming Systems (DFS), whose adherents employ practices to promote beneficial biodiversity that enhances productivity in the long term \cite{kremen2012diversified}.  Through a series of computational model experiments, we identify a mechanism that leads to a bimodal distribution of DFS adoption.  Specifically, we suggest that the path-dependency arising from a series of management decisions over time tends to drive behavior toward one of two extremes: virtually no adoption of DEPs, resulting in short-term economic efficiency advantages; versus sustained adoption of DEPs, leading to the long-term accural of ecological services.  In a series of experiments, we investigate the extent to which key decision factors drive behavior toward or away from DFS, finding that longer-term land tenure and sustained subsidy incentives may be important to promote DFS adoption.  
<!-- add "higher risk of environmental shocks" if we decide to include -->

\subsection{Diversified farming systems}

It has been widely observed that farms often fall into two general categories: small-to-medium operations that tend to sell into local, direct markets and take a longer view on sustainability; versus large monocropping operations that sell into the global commodities market and focus on short-term economic efficiency \cite{lyson2004commodity, lyson2008food}.  While attempts to understand the mechanisms behind this bifurcation into "civic" and "industrial" agriculture are not new, the situation remains complex \cite{ipes2018breaking}.  It is hypothesized that "civic" farmers benefit from the ES that flow from agrienvironmental practices, reducing the need for external inputs, curbing negative externalities, and increasing positive externalities, all of which have potential benefits, either directly or from public policy incentives \cite{kremen2012diversified}.  Meanwhile, "commodity" farmers, while more reliant on purchased inputs for fertility and pest control, are often larger, and derive their profits from higher per-annum revenue.

While DFS can bolster ecosystem services, the cost-benefit analysis of DEP adoption can be uncertain.  Practices to reduce topsoil loss and harmful runoff such as riparian buffers and hedgerows---often subsidized by government agencies like NRCS---present tradeoffs between payout and opportunity cost over time \cite{rein1999economic}.  Increasing crop rotational diversity requires built knowledge, reliable markets, and specialized equipment \cite{carlisle2014diversity}.  Further, if an ecosystem starts in a degraded state---for instance after decades of intensive monocultural cultivation and agrochemical input application---ecosystem restoration can be a slow process.  Increasing soil organic matter---crucial for nutrient and water cycling and retention---through compost application, crop rotation, or cover cropping can take years or even decades.  Rebuilding insect communities for pollination and pest control through perennial plantings or intercropping is similarly slow.  The uncertainty and/or lag time required to implement DEPs is a fundamental challenge of transitioning to DFS, since growers incur known costs in the short-term but long-term benefits are less clear.  Hence, it may be hypothesized that farmers in the simplified, monocultural state tend to remain there, because of strong path dependency and the big leap needed to transition successfully to DFS.

\subsection{Complexity and CHANS modeling}

Recent research in complexity theory reveals the importance of understanding nonlinear behaviors within dynamical systems.  For example, when pushed beyond some threshold, or tipping point, a system may enter a virtually-irreversible state, driving its behavior into divergent "basins of attraction," even given potent countervailing actions on the part of a decision-maker \cite{bar2019dynamics}.  These types of complex dynamics have been observed empirically across a wide variety of SESs, such that the identification of effective policy measures to effect change in these areas have been described as "wicked problems" that often confound traditional methods of analysis \cite{head2008wicked}.  As such, computational methods have begun to emerge as the go-to tools to study problems in the CHANS domain, typically involving the development of stylized computer models to identify features such as alternate equilibria and levers of change that affect dynamical behavior \cite{ostrom2009general}.  

While SESs like wildlife and fisheries management have been extensively studied in this way \cite{crowder2008impacts}, much of the research on agriculture has continued to revolve around unidisciplinary approaches, for example viewing food production through an economic commodity lens, or using natural science methods to develop new plant breeds or assess ecological outcomes like water contamination \cite{francis2008transdisciplinary}.  In recent decades, scholars have increasingly recognized the potential for wicked problems in agriculture to be illuminated by conceiving of agricultural systems as CHANS.  For example, using a simple SES computer model encompasing feedbacks between cultivation intensity, yield, and market price over time, \cite{vandermeer1997syndromes, vandermeer2012syndromes} identify a mechanism by which two "syndromes" may emerge within an agricultural marketplace, one defined by high prices, high intensity, and volatility; and the other by lower-prices, lower-intensity, and market stability. Many of the dynamical features found in other SES domains---including tipping points, periodic oscillations, and chaotic behavior---were observed.  While fundamentally rooted within a microeconomic paradigm, this study was among the first to identify a mechanism to explain complex dynamical behavior within agriculture as a CHANS.  Computational methods like agent-based modeling, network analytics, and machine learning have also been employed to discover new insights into livestock disease spread \cite{wiltshire2018using, wiltshire2019network}, {>>complete list<<}...

Through a CHANS lens, we hypothesize that the empirically-observed bifurcation in agricultural DFS adoption may be the result of complex tipping point dynamics, leading to two distinct stable states into which farmers are often drawn.  We view the adoption of agricultural diversification practices as a CHANS within which farmers must weigh uncertain tradeoffs between short- vs. long-term economic costs and benefits, and downstream ecological outcomes which may feed back to influence future productivity.  Based on existing observations and our own social-ecological data, we develop a Markov Decision Process (MDP) model to explore these complexities.  

MDP models help us understand the likely results of sequential decisions over time in contexts where outcomes are uncertain.  Stochastic Dynamic Programming (SDP) is the technical means by which we determine the optimum set of actions, i.e. “solve” an MDP model.  A utility function defines how good each solution is for the agent (or decision-maker), in terms of financial rewards, social rewards, or whatever utility metric fits the situation \cite{marescot2013complex}.  The decision-maker must make a series of decisions, adapting to the somewhat-random fluctuations associated with the natural system to make the best decision possible given the information available \cite{marescot2013complex}.  

The MDP approach has proven especially useful to model CHANS, such as public policy surrounding forest management, pest and disease spread, water management, and fisheries \cite{marescot2013complex, clark1989bioeconomic}.  MDPs have also seen limited application within agricultural decision-making, for example as agronomic decision-support tools \cite{kristensen2003general} or to understand livestock epidemic spread \cite{peyrard2007graph}.  Our model is the first to leverage an MDP to explore the social-ecological factors that underpin adoption of pro-environmental agricultural practices {>>is this a fair analysis?<<}.  

<!-- From proposal: By establishing MDP models as the basis of a conceptual framework for studying agricultural socio-ecological systems, we will help to build a rigorous theoretical basis for the application of CHANS to agricultural systems. The project will fill a key gap in agricultural social science and policy18 by studying the interacting effects of government policies, agri-conservation incentive programs, and supply chain/industry actor requirements on farmers’ ability and willingness to take up diversification practices. The project will also contribute to filling an important gap in the field of ecology by studying novel relationships between biodiversity, ecosystem functions, and ecosystem services and disservices in real-world management systems29,30. Specifically, we will assess how community composition of birds and soil microbes jointly influence food safety through the incidence and suppression of foodborne pathogens, and how soil microbial community composition affects soil functions and soil-based ecosystem services that affect farm sustainability. The integrated CHANS perspective will increase scientific understanding of the potential synergies and tradeoffs of how diversified farming practices affect biodiversity, ecosystem services, short-term profitability, and long-term sustainability. The decision support tool we prototype will make a lasting contribution to guide farmers and policymakers in making more informed choices that take into account the impact of a variety of potentially conflicting variables and influences.  -->


## Millie's additional work on subsidies
However, as the ecological dynamics increase in rate, which is relevant in analagous contexts of sequentially controlled ecological systems, this effect decreases (create figure for this?).
```{r setup, include = FALSE}
rm(list = ls(all.names = TRUE)) # clean environment

# load external scripts
source("../R/load-libraries.R")
source("../R/continuous-model.R")
source("../R/sim-plot-fxns.R")
source("../R/caorwa-plot-fxns.R")
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = "center",
                      dev = "cairo_pdf")

pal <- solarized_pal()(7) # global color pallette
set.seed(4) # random seed
```

```{r model_def, include = FALSE}
params <- list(benefit = 1.57, cost = 2, sigma = 0.1, r = 0.5)
sc2 <- list(benefit = 3, cost = 1, sigma = 0.1, r = 0.5)


discount <- 0.97
transition_fn <- function(s, a, params) s + params$r * (a - s)
utility_fn <- function(s, a, params) params$benefit * s - params$cost * a
model <- continuous_model(states, actions, params, transition_fn, utility_fn)

# solve the MDP
base_soln <- MDPtoolbox::mdp_value_iteration(model$P, model$U, discount)
base_soln_df <- tibble(state = states,
                       action = actions[base_soln$policy])

# soln_plot(base_soln_df)
#write_csv(base_soln_df, "../model-data/base_soln_df.csv.gz")
```

```{r global_sim_params, include = FALSE}
reps <- 500
init <- truncnorm::rtruncnorm(reps, 0, 1, 0.5, 0.2) %>% 
  map_int(function(x) which.min(abs(x - states)))

```










```{r subsidies, include = FALSE}
scenarios_r <-
  tidyr::crossing(# Do all combinations of:
                  cost = 1,
                  r = 0.5,
                  benefit = c(1.57,2),
                  sigma = 0.1,
                  Tmax = 20
  ) %>% tibble::rownames_to_column("id")

scenarios_d <- tidyr::crossing(# Do all combinations of:
                  #cost = seq(0, 1, by = 0.1),
                  r = 0.1,
                  benefit = c(1.57,2),
                  sigma = 0.1,
                  Tmax = 20,
                  N = c(1, 20)
  ) %>% tibble::rownames_to_column("id") 
```

We then create a function to simulate the multiple scenarios through
time

```{r simulate, include = FALSE}
no_subs_sim <- function(row) {
  model <- continuous_model(states, actions, row, transition_fn, utility_fn)
  soln <- MDPtoolbox::mdp_value_iteration(model$P, model$U, discount)
  # simulate subsidy period
  # pad to Tmax with baseline decision rule
  sim(soln, Tmax = 20) %>% filter(time == 20) %>% summarise(mean(state))
}
```


```{r no_subsidy_r, include = FALSE}
no_subsidy <-
  tidyr::crossing(# Do all combinations of:
                  # Tsubs = 11,
                  r = seq(0.1, 3, by = .2),
                  benefit = 1.57,
                  sigma = 0.1,
                  Tmax = 20,
                  cost = 1
  ) %>% tibble::rownames_to_column("id")
```
And apply that function to all of the scenarios of interest

```{r all_subsidies, include = FALSE}
no_sub_results <- no_subsidy %>%
  purrr::transpose() %>%
  furrr::future_map_dfr(no_subs_sim, .id = "id") %>%
  left_join(no_subsidy, by = "id") %>%
  rename(no_sub_state = `mean(state)`) %>%
  select(r, no_sub_state)

sub_results <- subsidies %>%
  purrr::transpose() %>%
  furrr::future_map_dfr(subs_sim, .id = "id") %>%
  left_join(subsidies, by = "id") %>%
  left_join(no_sub_results, by = "r")
```

```{r grid, fig.cap = "how does r effect subsidy structure impacts", fig.width = 4.5, fig.asp = 1}
sub_results %>% rename(state = `mean(state)`) %>%
  mutate(delta = state-no_sub_state)%>% ggplot(aes(x = Tsubs, y = r, fill = state)) + geom_tile()

```



```{r indiv_fig_6}
# ggarrange(
#   plt_sim_b_sweep(fast_r_sims, title = ggtitle("A. Fast ecological change rate"), 
#                 ylab = "Density", col = pal[4], rmarmod = -5),
#   plt_sim_b_sweep(myopic_d_sims, title = ggtitle("B. Myopic decision-making"), 
#                 tpos = "panel", col = pal[7], lmarmod = -2.5, rmarmod = -2.5),
#   plt_sim_b_sweep(chans_sims, title = ggtitle("C. Human/enviro. interaction"), 
#                 tpos = "panel", col = pal[1], lmarmod = -5),
#   nrow = 1, ncol = 3, widths = c(1,1,1)
# )

# ggarrange(
#   plt_b_sweep_peaks(b_sweep_peaks(fast_r_sims), title = ggtitle("A. Fast ecological change rate"),
#                     ylab = "ES state density peak(s)", col = pal[4], rmarmod = -5),
#   plt_b_sweep_peaks(b_sweep_peaks(myopic_d_sims), title = ggtitle("B. Myopic decision-making"),
#                     tpos = "panel", col = pal[7], lmarmod = -2.5, rmarmod = -2.5),
#   plt_b_sweep_peaks(b_sweep_peaks(chans_sims), title = ggtitle("C. Human/enviro. interaction"),
#                     tpos = "panel", col = pal[1], lmarmod = -5),
#   nrow = 1, ncol = 3, widths = c(1,1,1)
# )
```


