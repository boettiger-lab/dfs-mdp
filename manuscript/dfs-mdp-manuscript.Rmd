---
title: "Tipping points in the adoption of agroecological practices" # changed from "diversified agroecological" to "agroecological diversification" because the former suggests more of a diversity of practices, whereas we're trying to convey practices that support biodiversity - s.w. 3/5/20
author:
  - name: Melissa Chapman
    affiliation: espm
  - name: Serge Wiltshire
    affiliation: espm
  - name: Timothy Bowles
    affiliation: espm
  - name: Liz Carlisle
    affiliation: ucsb
  - name: Fredrico Castillo
    affiliation: espm
  - name: David Gonthier
    affiliation: ky
  - name: Alastair Iles
    affiliation: espm
  - name: Daniel Karp
    affiliation: davis
  - name: Claire Kremen
    affiliation: espm, ucb
  - name: Jeff Liebert
    affiliation: cornell
  - name: Elissa Olimpi
    affiliation: davis
  - name: Amber Sciligo
    affiliation: organic
  - name: Jennifer Thompson
    affiliation: espm
  - name: Hannah Waterhouse
    affiliation: espm
  - name: Kenzo Eszquivel
    affiliation: espm
  - name: Carl Boettiger
    affiliation: espm
    footnote: Corresponding Author
address:
  - code: espm
    address: "Dept. of Environmental Science, Policy, and Management, University of California Berkeley, Berkeley, CA, USA"
  - code: ubc
    address: "Institute of Resources, Environment and Sustainability, University of British Columbia, Vancouver, BC, Canada"
  - code: ucsb
    address: "Environmental Studies, University of California Santa Barbara, Santa Barbara, CA, USA"
  - code: davis
    address: "Wildlife, Fish, and Conservation Biology, University of California Davis, Davis, CA, USA"
  - code: ky
    address: "Dept. of Entomology, University of Kentucky, Lexington, KY, USA"
  - code: cornell
    address: "School of Integrated Plant Science, Cornell University, Cornell, NY, USA"
  - code: organic
    address: "The Organic Center, Washington, DC, USA"
    
abstract: The existence and impact of tipping points are of immense interest in both social and ecological research. Despite widespread recognition of feedbacks between the two domains, it is often assumed that the underlying forces that lead to nonlinear behaviors rest within either human or natural processes. Our work shows how tipping points can arise in a stylized coupled human and natural systems (CHANS) model representing adoption of agroecological diversification practices.  Even when neither system alone has complex dynamics, a farmer's adoption choice, based on their perceived utility over a given time horizon, together with ecological services derived from stochastic environmental change, can drive systems into alternate stable states. Because ecosystem services take years to accrue, farmers on degraded land, or those operating under a shorter time horizon, are disincentivized to invest in agroecology, while others are more likely to bolster ecosystem services further by adopting additional agroecological practices. This path dependency leads to a bifurcation into either a more-simplified (conventional) or more-diversified (agroecological) farming approach, which echoes empirical findings. We show that this tipping point need not be an inherent feature of either ecological or decision dynamics, but can emerge as a general pattern when a simple ecosystem model and a rational decision process are dynamically coupled over time. We suggest that this finding has important implications for agricultural and land use policy design across a range of domains, including land tenure and agroecological subsidies.

keywords:
  - agriculture,
  - ecosystem services,
  - tipping points,
  - diversification practices,
  - decision-making
bibliography: alt_stable_states.bib
date: "`r Sys.Date()`"
output: rticles::elsevier_article
layout: 3p # review # review = doublespace, 3p = singlespace, 5p = two-column
header-includes: 
  - \journal{TBD}
  - \graphicspath{{ext-figs/}}
  - \usepackage{float}
  - \linenumbers

---

```{r render_to_word_doc, eval = FALSE}

# run this to generate a word doc
# not perfect, will have to format word doc after, but best I could come up with
library(rmarkdown)
render("dfs-mdp-manuscript.Rmd", word_document())

```


```{r setup, include = FALSE}
rm(list = ls(all.names = TRUE)) # clean environment

# load external scripts
source("../R/load-libraries.R")
source("../R/continuous-model.R")
source("../R/sim-plot-fxns.R")
source("../R/caorwa-plot-fxns.R")
# load CA_OR_WA farmer survey dataset
caorwa_data <- read.csv("../external-data/ADAPT_CA-OR-WA_2_2020.csv")

knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      # eval = FALSE, # to knit faster - comment out to run code
                      fig.align = "center",
                      dev = "cairo_pdf")

pal <- solarized_pal()(7) # global color pallette
set.seed(4) # random seed
```

```{r model_def, include = FALSE}
# set up the MDP
actions <- seq(0, 1, length = 100)
states <- seq(0, 1.5, length = 100)
params <- list(
  benefit = 1.56, #orig. benefit = 1.57, 
  cost = 1, 
  sigma = 0.1, 
  r = 0.1, 
  discount = 0.97, 
  Tmax = 20)
transition_fn <- function(s, a, params) s + params$r * (a - s)
utility_fn <- function(s, a, params) params$benefit * s - params$cost * a
model <- continuous_model(states, actions, params, transition_fn, utility_fn)

# solve the MDP
base_soln <- MDPtoolbox::mdp_value_iteration(model$P, model$U, params$discount)
base_soln_df <- tibble(state = states,
                       action = actions[base_soln$policy])

#write_csv(base_soln_df, "../model-data/base_soln_df.csv.gz")
```

```{r global_sim_params, include = FALSE}
reps <- 500
init <- truncnorm::rtruncnorm(reps, 0, 1, 0.5, 0.2) %>% 
  map_int(function(x) which.min(abs(x - states)))

```


# Introduction

<!-- 
outline:

para 1: tipping points
para 2: CHANS
para 3: Ag + DFS
para 4: This paper ... stylized model
-->


Both ecosystems and social systems have been observed to change states abruptly as the result of crossing a critical threshold or "tipping point". Theories of ecological multistability have long described this phenomenon [@scheffer2003catastrophic] and explored how ecological management impacts stability landscapes [@Horan7333], with tipping points assumed to stem from complex ecological processes like population dynamics. Similarly, examples from social science--from the collapse of societies [@downey2016european], to social network dynamics such as the spread of innovations [@kuehn2014critical]--suggest that tipping points may result from complex features of human systems. Despite widespread interest in the causes and location of tipping points in integrated socio-ecological systems, it has generally been assumed that the underlying dynamical complexity can be ascribed to either social processes *or* natural phenomena.

<!-- so what?  I think the relevant implication here is that tipping points would be 
     more common than expected, appearing even when not anticipated by studying eco or 
     social in isolation.  Thus the real take-home here is a need for more CNHS
     research, particularly that which uses fully dynamic and truly coupled modeling.-->


Empirically exploring tightly coupled dynamic systems presents numerous research challenges [@kline2017integrating].  In such systems, human decisions impact ecological processes, and the resultant changes create feedbacks that alter the scope and efficacy of future decisions [@ostrom2009general; @walker2004resilience; @liu2007complexity].  For example, agricultural management choices can enhance or degrade ecological services that affect the long-term productive capacity of the land, impacting future financial returns, and limiting future decision possibilites [@zhang2007ecosystem].  A complicating factor is that the temporal dynamics of ecological processes do not always align with the temporal scale of human decision-making.  For example, land management to promote ecosystem services may require sequential investments over time and/or take years to accrue [@morandin2016pest; @blaauw2014flower], meaning adoption of these practices requires decisionmakers to be forward looking, adaptive, and cognizant of environmental and economic uncertainty. 
<!-- I think the point of this paragraph is answering "why hasn't this coupling been done"
     by stating "it's hard".  That's good, but we should probably be more blunt about it. 
     maybe could start with the rhetorical question, or simply extend first sentence:
     "... which frequently lead researchers to focus on the dynamics of either the 
     ecological or social component in isolation, and thus miss the tipping point"
     
     Also, not sure if this is the second paragraph, I think it might be better as the
     third paragraph?
-->



Agriculture is a fundamental driver of anthropogenic ecological change [@stoate2009ecological; @foley2005global; @foley2011solutions], providing a valuable context to examine how social and ecological systems interact.  
<!-- Good, but stay with/tie back to the theme: "yet tightly coupled dynamical 
     models of this coupling are rare."  (or something like that)-->
~~Agriculture influences both human and ecosystem well-being, while production practices vary in their environmental impacts, long-term sustainability, financial viability, and climate resilience.~~<!--cut? this is self-evident? or can we say it more succiently with a citation?-->
<!-- We need to move introducing the CHANS acronym and citation into paragraph 1 (or 2) -- otherwise reader will think we are talking about CHANS without being aware that it's already 'a thing'-->
It is increasingly recognized that effective policies to address environmental issues like the long-term sustainability of agricultural practices require interdisciplinary approaches which consider both human decision-making and ecology as a coupled human-and-natural system (CHANS) [@liu2007complexity; @alberti2011research].  

<!--  I think we need this next paragraph to move up into the previous one.  We could
      go right into this after the first sentence of the previous paragraph.  -->
Here we focus on Diversified Farming Systems (DFS), which use agricultural practices that promote beneficial biodiversity and bolster ecosystem services, simultaneously enhancing farm- and landscape-scale productivity  [@kremen2012diversified].  While existing research has increased our understanding of how diversification practices affect ecological and financial outcomes [@rosa2019ecological], an integrated approach requires consideration of the feedback loop between adoption of a given practice, resultant ecological change, and future decision landscapes. Such an approach provides a framework to analyze the potential synergies and tradeoffs inherent to how diversified farming systems affect and are affected by ecosystem processes. 

<!-- Intro sentence isn't that strong here.  Point of this paragraph is to cite previous work that might appear similar but really isn't.  Possibly, we can roll this into the previous paragraph.  Message here is actually similar to what is currently paragraph 2.-->
Computational approaches to explore structural attributes of human-environment systems can illuminate core dynamics, suggest levers of change, and highlight important assumptions to explore empirically.  However, much of the existing literature in this area focuses either on human decision-making (with ecological processes being exogenous to the model), or explores the complexity of ecological processes without sufficiently considering the role of adaptive human agents  [@vandermeer2012syndromes].  Further, those techniques that do investigate dynamic processes and responsive decision-making don't generally allow for forward looking agents [@lippe2019using], ultimately misrepresenting the complex coupling of these systems.  

<!-- excellent -->
This paper presents a stylized model of agroecological diversification practice adoption to explore the complex dynamical properties that result specifically from interactions between adaptive decision-making and an ever-changing environment.  We find a novel mechanism for bistability that is the result not of complex structural assumptions within either the human or natural system, but simply the rates at which the two systems interact over time.  While our model necessarily simplifies both decision-making and environmental processes, it provides a platform to integrate empirical findings and explore emergent properties of CHANS.  Additionally, we suggest important implications of such tipping point dynamics for agroecological policy design.


# Conceptual model description

We explore the transition to and from diversified farming systems using a Markov Decision Process (MDP) in which a produce farmer makes a series of agroecological choices over time (\ref{fig:res_conceptual}).  Each year the agent chooses an "action" of 0\% to 100\% investment in adopting or maintaining diversification practices.  A "system state" represents the degree of beneficial ecosystem services derived from those decisions.  More investment corresponds to a greater probability of transitioning to a higher (more beneficial) ecological state the next year.  While higher ecological states benefit the agent, higher investment actions also come with a greater associated cost.  By defining parameter values for cost, benefit, transition stochastiticity, ecological change rate, and discounting (values given in Methods, Tab \ref{tab:baseline_params}), we can calculate the optimal action strategy based on the agent's expected rewards over a defined time horizon.  

\begin{figure}
\centering 
\includegraphics[width=.75\textwidth]{external-figs/dfs_mdp_conceptual_fig_8.png}
\caption{Conceptual diagram of the DFS-MDP model.  The farmer's choice of how much to invest (time and/or money) into diversification practices (DP) adoption is shown in blue, and the resulting ecosystem services (ES) state in green, with a more diversified state at the top, and a more simplified state at bottom.  Each year $t$, the farmer evaluates which action they judge to have the highest expected utility based on the perceived utility function $(u)$ and the ecosystem state transition probability function $(p)$.  $(p)$ describes how, for a given state and action at year $t$, the ecosystem responds stochastically at year $t+1$.  The updated ecosystem state then feeds back to influence the farmer's future choices.  This leads to complex tradeoffs arising from the coupling of ecological processes with the series of DP adoption decisions made by the farmer.}
\label{fig:res_conceptual}
\end{figure}


# Results

Using this model, we observe the behavior of agents' sequential choices and resultant environmental outcomes over time.  For each experiment, we conduct 500 runs, with agents' initial ecosystem states distributed normally around a mean of $\bar{s} = 0.5$.  Fig \ref{fig:res_bimodal} shows that, after having followed the optimal decision strategy for 19 years, at $t = 20$ agents have largely settled into two groups, with some farms transitioning to more simplfied (conventional) farming systems, and others to more diversified (agroecological) systems.  Further, we find strong path dependency, with only 17\% of agents who started in a simplified ($s < 0.5$) state concluding in a diversified ($s > 0.5$) state, and only 7\% initially in the diversified state transitioning to simplified.


```{r base_case_sim, include = FALSE}
sim <- function(soln, 
                Tmax = params$Tmax,
                x0 = init){
  map_dfr(1:length(x0), 
          function(i) sim_mdp(model$P, model$U, soln$policy, params$discount, x0 = x0[i], Tmax = Tmax), 
          .id = "reps")
}
sims_baseline <- sim(base_soln)

# p_up_dn(sims_baseline)
#write_csv(sims_baseline, "../model-data/sims_baseline.csv.gz")
```


```{r res_bimodal, fig.cap = "Simulations of 500 model agents over 20 farming seasons.  Initial ES states follow a truncated normal distribution (mean = 0.5; S.D. = 0.2; truncated at [0,1]).  Agents then utilize decision strategy $\\pi$ as shown in Fig \\ref{fig:res_strategy} until $t = 20$.  (A) State of each agent throughout each run.  (B) Initial ES distribution (dark blue) and bimodal density distribution at $t = 20$ (light blue), with peaks annotated. (C) Observed bimodal DP adoption distribution in our survey data.", fig.width = 6, fig.asp = .5}

ggarrange(
  sim_plot_ts(sims_baseline, title = ggtitle("A. ES state over time"), rmarmod = -5), 
  sim_plot_dens(sims_baseline, title = ggtitle("B. Init. and final state"), tpos = "panel", lab_lo_peak = TRUE, lab_hi_peak = TRUE, lmarmod = -5), 
  caorwa_dp_count_hst(caorwa_data, title = ggtitle("C. Empirical distribution")), 
  widths = c(2.75, 2, 1.75), nrow = 1, ncol = 3
)

# p_up_dn(sims_baseline)
```

## Optimal decision strategy
The decision strategy $\pi$ describes the optimal course of action for a given state and is the same for all agents in the simulation.  Fig \ref{fig:res_strategy} reveals that there is a critical bifurcation, or tipping point, at a specific ecosystem state, below which the highest expected value is derived by investing little to nothing into diversified farming systems, and above which the optimum action becomes near-full investment. Over time, this results in the bimodal distribution of ecosystem states in Fig \ref{fig:res_bimodal}. 

```{r res_strategy, fig.cap = "Optimal decision strategy $\\pi$ as a function of ecosystem state, showing a tipping point at $s \\approx 0.52$.  The upper $x$ axis limit is the 99th percentile of observed states in our simulation results ($s \\approx 1.23$).", fig.width = 3, fig.asp = 1}

state99th <- sims_baseline %>% 
            mutate(state = states[state]) %>% 
            pull(state) %>% 
            quantile(.99) %>% 
            unname()
tpt <- 0
for(si in 1:length(states)-1) {
  if(base_soln_df$action[si] < .1 && base_soln_df$action[si+1] > .9) {
    tpt <- base_soln_df$state[si] + ((base_soln_df$state[2] - base_soln_df$state[1]) / 2)
  }
}

soln_plot(base_soln_df %>% filter(state <= state99th), tpt = tpt)

```


## Land tenure

With 39\% of U.S. farmland under lease [@usda2016], and with widely-varying rental agreements, the impact of land tenure on best management practice adoption has been increasingly scrutinized.  For example, a study of U.S. corn producers found that cash renters were less likely than land owners to implement grassed waterways, strip cropping, contour farming, or conservation tillage [@soule2000land].  A study conducted in British Columbia found that tenant farmers planted fewer perennial crops than land owners [@fraser2004land].  Our own ongoing research with produce farmers in California's Salinas Valley suggests that land tenure is an important factor in decisions about cover cropping and crop rotation.  In addition, investments in agroecology may require access to credit, which often also hinges on secure land tenure as collateral [@richardson2015land].

Using the same parameters outlined above, we solve the MDP on a finite two-year time horizon, representing the shorter window within which tenant farmers often make decisions (Fig \ref{fig:res_tenure}).  Comparing the final state distribution of the baseline versus the short tenure model shows that, as expected land tenure duration decreases, it becomes optimal to curtail agroecological adoption.  This results in ecosystem state degradation even among farm sites with an initially high value, with 92\% of farmers ending up in the simplified state.  These results echo empirical findings from a recent large-scale survey of U.S. west coast produce growers, which show that farmers who lease land are roughly 20\% less likely to invest in at least one diversification practice.  

```{r short_tenure_sim, include = FALSE}
short_tenure_soln <- MDPtoolbox::mdp_finite_horizon(model$P, model$U, params$discount, N = 2)
sims_short_tenure <- sim(short_tenure_soln)
#write_csv(sims_short_tenure, "../model-data/sims_short_tenure.csv.gz")
```

```{r res_tenure, fig.cap = "(A) Result of short land tenure on DP adoption.  The simulation is identical to that in Fig \\ref{fig:res_bimodal}, but the MDP is solved under a finite, two-year time horizon. (B) Comparison between final state distribution of short- vs. long-tenure model runs.  (C) Probability of ecosystem services state being $\\geq 0.125$ at $t=20$ for the short-tenure simulation vs. the base-case simulation. (D) Impact of land tenure on the probability of a farmer in our survey dataset adopting at least one DP.", fig.width = 6, fig.asp = .5}

ggarrange(
  sim_plot_ts(sims_short_tenure, title = ggtitle("A. Short-tenure timeseries"), endcol = pal[3], rmarmod = -5),
  sim_plot_dens_comp(sims_baseline, sims_short_tenure, label1 = "Long\ntenure\nfinal", label2 = "Short\ntenure\nfinal", title = ggtitle("B. ES state distribution"), tpos = "panel", lmarmod = -5, rmarmod = -5),
  ggarrange(
    sim_tenure_thresh_bar(sims_baseline, sims_short_tenure, thresh = 0.125, title = ggtitle("C. Simulation data")), 
    caorwa_tenure_thresh_bar(caorwa_data, title = ggtitle("D. Empirical data")), 
    nrow = 2, ncol = 1),
  widths = c(2.5, 2.5, 1.65), nrow = 1, ncol = 3
)

# p_up_dn(sims_short_tenure)
```


## Agroecological incentives

While land tenure is intertwined with land use decisions, agricultural incentives have also become an integral part of farming over the past half-century, and policymakers are continually called upon to weigh farm viability against food affordability and environmental sustainability to design effective incentive packages [@graddy2017supply]. Agricultural incentives and subsidies have a range of goals, one of which is to promote sustainable management practices. We explore the impact of incentive duration on policy efficacy by implementing two competing incentive structures: a short-term (two-year) incentive which completely covers the cost of diversification practice adoption, versus a longer-term (ten-year) incentive which only partially offsets the transition cost.  Within the model, agents adapt their decision strategy during the subsidy period, and at its conclusion they revert to the baseline strategy.  Formally, the cost of each incentive package to the taxpayer is equal, and in fact the short-term subsidy is technically more valuable if economic discounting is applied.  

Fig \ref{fig:res_subsidy} shows that longer, more sustained incentive programs may be more effective at nudging behavior over the critical threshold toward more sustainable systems.  Comparing the subsidy simulations to the base case, non-subsidy results, we find that, while both incentive packages worked to some extent, the sustained incentive was much more effective at moving the needle.  Due to the tipping point dynamic, once an agent has crossed the threshold to the diversified state, it becomes much less likely that they will fall back toward the simplified state.  Since ecosystem state change in the model is somewhat stochastic, as it is in real-world ecosystems, it may take a series of investment actions before the ecosystem reacts.  Due to this time delay, longer-term subsidy packages have a higher chance of nudging behavior beyond the critical threshold, ultimately resulting in more agroecological practice adoption.  


```{r subsidies_sim, include = FALSE}
# set subsidy simulation parameters
Tsubs1 <- 2
Tsubs2 <- 10

# calc modified cost during subsidy = 1 - 2 / Tsubs
Csubs1 <- 1 - 2 / Tsubs1
Csubs2 <- 1 - 2 / Tsubs2

# subsidy simulation fxn
subs_sim <- function(params) {
  subs_model <- continuous_model(states, actions, params, transition_fn, utility_fn)
  subs_soln <- MDPtoolbox::mdp_value_iteration(subs_model$P, subs_model$U, params$discount)
  # simulate subsidy period
  start <- sim(subs_soln, Tmax = params$Tsubs, x0 = init)
  xi <- start %>% filter(time == params$Tsubs) %>% pull(state)
  # pad to Tmax with baseline decision rule
  rest <- sim(base_soln, Tmax = params$Tmax - params$Tsubs, x0 = xi) %>% filter(time!=0) %>% mutate(time = time + params$Tsubs)
  bind_rows(start, rest) 
}

# run subsidy simulation
sims_subs_abrupt <- subs_sim(list(benefit = params$benefit, cost = Csubs1, sigma = params$sigma, r = params$r, discount = params$discount, Tsubs = Tsubs1, Tmax = params$Tmax))
sims_subs_sust <- subs_sim(list(benefit = params$benefit, cost = Csubs2, sigma = params$sigma, r = params$r, discount = params$discount, Tsubs = Tsubs2, Tmax = params$Tmax))

#write_csv(sims_subs_abrupt, "../model-data/sims_subs_abrupt.csv.gz")
#write_csv(sims_subs_sust, "../model-data/sims_subs_sust.csv.gz")
```

```{r res_subsidy, fig.cap = "Replicate simulations from 500 normally-distributed starting states (mean = 0.5; S.D. = 0.2; truncated at [0,1]) over 20 timesteps.  (A) Large, abrupt subsidy (100\\% of adoption expenses are covered during the initial two years).  (B) Smaller, more sustained subsidy (adoption cost is 80\\% of baseline during the first 10 years).  Ignoring discounting, subsidies have the same total cost to the funder (the equivalent of 2 years' worth of full adoption cost offsets).  After subsidy is removed, agents adjust their decision rule to that of the base case (i.e. no subsidy) for the remainder of the run.  (C) The sustained subsidy drove more adoption at $t = 20$.", fig.width = 6, fig.asp = .5}
ggarrange(
  sim_plot_ts(sims_subs_abrupt, title = ggtitle("A. Abrupt subsidy"), 
              annotate = TRUE, an_x = Tsubs1, an_lab = sprintf("%i year\n%i%% off", Tsubs1, round((1-Csubs1)*100)), 
              rmarmod = -10, endcol = pal[5]),
  sim_plot_ts(sims_subs_sust, title = ggtitle("B. Sustained subsidy"), 
              annotate = TRUE, an_x = Tsubs2, an_lab = sprintf("%i year\n%i%% off", Tsubs2, round((1-Csubs2)*100)), 
              tpos = "panel", ytxtoff = T, endcol = pal[6], rmarmod = -5, lmarmod = -5),
  sim_plot_dens_comp(sims_subs_abrupt, sims_subs_sust, sims_base = sims_baseline, 
                     label1 = "Abrupt\nsubsidy", label2 = "Sustained\nsubsidy", label_base = "No\nsubsidy", 
                     title = ggtitle("C. Final ES state distribution"), tpos = "panel", 
                     cvec = c(pal[2], pal[5], pal[6]), lmarmod = -5, rmarmod = -5),
  nrow = 1, ncol = 3, widths = c(1,1,1)
)

# print("abrupt: ")
# p_up_dn(sims_subs_abrupt)
# print("sustained: ")
# p_up_dn(sims_subs_sust)
```


## Importance of temporal dynamics in coupled system trajectories

Our model shows how a simple coupling of human choices and ecological response can result in bistable landscapes of high and low diversification practice adoption.  Importantly, this tipping point disappears when human and natural systems are decoupled.  To explore this, we incrementally sweep through cost/benefit ratios and examine the effect on final ecosystem state distributions.  As the ratio grows, at some point the decision strategy favors full investment into DPs, and conversely, a sufficiently low ratio will result in no DP adoption.  

Fig \ref{fig:res_b_sweep} shows that, with human/environment interaction, there exists a region of cost/benefit space within which various bimodal ecosystem state distributions emerge.  However, when ecological processes become fast enough that the ecosystem responds almost-immediately to farmer actions ($r = 0.95$), it becomes impossible to parameterize the model's cost-benefit ratio to result in alternate stable states.  Similarly, as decisions become temporally-myopic (time horizon = 2 yrs.), the potential for bistability also disappears.  Only when both a gradually-changing environment and a forward-looking decision-maker are coupled do tipping point phenomena emerge in decision strategy, leading to alternate stable diversification states.  

```{r sim_b_sweep_fxn, include = FALSE}
sim_b_sweep <- function(scenarios, inf_fin, t_horiz = 2) {
  
  sim_b_sweep_scenario <- function(params) {
  model <- continuous_model(states, actions, params, transition_fn, utility_fn)
  if(inf_fin == "infinite") {
    soln <- MDPtoolbox::mdp_value_iteration(model$P, model$U, params$discount)
  } else if(inf_fin == "finite") {
    soln <- MDPtoolbox::mdp_finite_horizon(model$P, model$U, params$discount, N = t_horiz)
  } else stop('inf_fin must be "infinite" or "finite"')
  sim(soln, Tmax = params$Tmax) %>% 
    filter(time == params$Tmax)
  }
  
  scenarios %>%
  purrr::transpose() %>%
  furrr::future_map_dfr(sim_b_sweep_scenario, .id = "id") %>%
  left_join(scenarios, by = "id") %>%
  mutate(state = states[state])
}

```

```{r run_b_sweep_sims, include = FALSE}
# baselines: benefit = 1.57, cost = 1, sigma = 0.1, r = 0.1, discount = 0.97
fast_r_scenarios <-
  tidyr::crossing(cbr = seq(.825, .975, length.out = 40),
                  cost = params$cost,
                  sigma = params$sigma,
                  r = 0.95,
                  discount = params$discount,
                  Tmax = params$Tmax) %>% 
  tibble::rownames_to_column("id") %>%
  mutate(benefit = cost / cbr)
fast_r_sims <- sim_b_sweep(fast_r_scenarios, "infinite")

myopic_d_scenarios <- 
  tidyr::crossing(cbr = seq(.025, .175, length.out = 40),
                  cost = params$cost,
                  sigma = params$sigma,
                  r = params$r,
                  discount = params$discount,
                  Tmax = params$Tmax) %>% 
  tibble::rownames_to_column("id") %>%
  mutate(benefit = cost / cbr)
myopic_d_sims <- sim_b_sweep(myopic_d_scenarios, "finite", t_horiz = 2)

chans_scenarios <- 
  tidyr::crossing(cbr = seq(.55, .7, length.out = 40),
                  cost = params$cost,
                  sigma = params$sigma,
                  r = params$r,
                  discount = params$discount,
                  Tmax = params$Tmax) %>% 
  tibble::rownames_to_column("id") %>%
  mutate(benefit = cost / cbr)
chans_sims <- sim_b_sweep(chans_scenarios, "infinite")
```


```{r find_b_sweep_density_peaks_fxn, include = FALSE}

b_sweep_peaks <- function(sims, smoothing = 1.5, ythresh = 0.125, output_bizone = FALSE) {
  bimin = 0
  bimax = 0
  peaks <- tibble(cbr = numeric(), peak = numeric())
  for(this_cbr in unique(sims$cbr)) {
    dens <- density((sims %>% filter(cbr == this_cbr))$state, adjust = smoothing)
    dens <- tibble(x = dens$x, y = dens$y) %>% filter(y >= ythresh)
    ps <- dens$x[findPeaks(dens$y)]
    for(p in ps) {
      peaks <- add_row(peaks, cbr = this_cbr, peak = p)
    }
    if(output_bizone && length(ps) > 1) {
      if(bimin == 0) {
        bimin = this_cbr
      }
      bimax = this_cbr
    }
  }
  if(output_bizone) {
    c(bimin, bimax)
  } else {
    peaks 
  }
}

```


```{r res_b_sweep, fig.cap = "For each scenario (fast ecological process, temporally-myopic decisions, and coupled system), cost/benefit ratio was varied incrementally over 40 values, indicated by color shade, across a range of width 0.15 encompassing the transition between a ``never invest'' to an ``always invest'' policy.  For each $c:b$, replicate simulations were conducted from 500 normally-distributed starting states (mean = 0.5; S.D. = 0.2; truncated at [0,1]) over 20 timesteps.  Upper plots show density curves of ES state at $t=20$ for each $c:b$.  Lower plots show values of density curve peak(s) for each $c:b$.  (A) With fast ecological change rate ($r = 0.95$), no bimodality is seen. (B) With a short-term decision strategy (solving the MDP over a 2-year time horizon), no bimodality is seen.  (C) Only when both forward-looking decision-making and a slowly-adapting environment are included do complex features such as bimodality emerge.", fig.width = 6.5, fig.asp = .6}

ggarrange(
  ggarrange(
    plt_sim_b_sweep(fast_r_sims, title = ggtitle("A. Fast ecological change rate"), 
                    ylab = "Density", col = pal[4], rmarmod = -7, dnmarmod = -2.5) + theme(legend.position="none"),
    plt_b_sweep_peaks(b_sweep_peaks(fast_r_sims), 
                      ylab = "Cost/benefit ratio", col = pal[4], rmarmod = -7, upmarmod = -2.5), 
    nrow = 2, ncol = 1, heights = c(1,1), align = "v"
  ),
  ggarrange(
    plt_sim_b_sweep(myopic_d_sims, title = ggtitle("B. Myopic decision-making"), 
                    tpos = "panel", col = pal[7], lmarmod = -3.5, rmarmod = -3.5, dnmarmod = -2.5) + theme(legend.position="none"),
    plt_b_sweep_peaks(b_sweep_peaks(myopic_d_sims), 
                      col = pal[7], lmarmod = -3.5, rmarmod = -3.5, upmarmod = -2.5), 
    nrow = 2, ncol = 1, heights = c(1,1), align = "v"
  ),
  ggarrange(
    plt_sim_b_sweep(chans_sims, title = ggtitle("C. Human/enviro. interaction"), 
                    tpos = "panel", col = pal[1], lmarmod = -7, dnmarmod = -2.5) + theme(legend.position="none"),
    plt_b_sweep_peaks(b_sweep_peaks(chans_sims), bizone = b_sweep_peaks(chans_sims, output_bizone = TRUE),
                      col = pal[1], lmarmod = -7, upmarmod = -2.5), 
    nrow = 2, ncol = 1, heights = c(1,1), align = "v"
  ),
  nrow = 1, ncol = 3, widths = c(1,1,1)
)


```


# Discussion

Our analysis suggests a mechanism for bistability in coupled human and natural systems that is not the result of complex structural assumptions about either system alone, but rather the temporal interactions between forward-looking decisions and ecological processes. While the concepts of regime shifts and tipping points within coupled human and natural systems [@lade2013regime] have been previously explored, our results cast light on temporal mechanisms that might help to explain this phenomenon. We suggest this knowledge provides novel considerations not only for coupled human and natural systems research but also agricultural policy. 

By representing diversified agroecological adoption as a coupled system, we find that the empirically-observed bistability may be the result of tipping points in the optimal sequence of decisions regarding slow ecological processes, rather than tipping points inherent in the ecological dynamics or the cognitive/social predispositions of human agents alone.  

In light of historical agricultural catastrophes like the Dust Bowl, the importance of informed policy action in response to stressors like climate change and soil degradation is imperative. Offering incentives and encourage the adoption of agroecological diversification practices is important for increasing food system resilience to global change [CITE]. Existing case studies emphasize that policy mechanisms designed to promote agricultural sustainability have complex ramifications [@ipes2018breaking]. Policy design must take into account the likely case of thresholds at which particular farming practices become more or less viable. 
We suggest that the temporal component of decision-making and  feedbacks is an important consideration for incentive and land tenure agricultural policies aiming to promote more resilient food systems. Compared to short-term subsidies, longer-term incentives were found to be more successful in moving farmers who started in the simplified ecological states to  diversified states.  A ramification of this finding is that the perceived stability of subsidy programs over time may be an important driver of their efficacy. Since the transitional barrier between the two stable states represents a precarious economic position, if a subsidy is not guaranteed for a long enough period to get significant benefits from the ecological feedbacks, the farmer may be incentivized to simply continue in their initial state.  With U.S. Farm Bills being overhauled every five years, a farmer may have limited confidence that a critical subsidy program will be sufficiently long-lived, suggesting that a policy lever may be to extend the sunsetting of agroecological policy bills [@jackson200950].  

Land tenure is known to affect sustainable agricultural practice adoption [@soule2000land; @fraser2004land; @richardson2015land; @long2017hedgerow]. For example, landowners or long-term lease holders have a larger stake in the productive quality of their soil ecology. By coupling the rate of ecological change with the time horizon of decision-making under different tenure situations we illustrate why secure land tenure is integral to the adoption of diversified agroecological practices. Policies that increase land tenure duration, such as regulating lease agreement terms, providing low interest loans, or promoting stable farm succession plans, may therefore represent a key lever to nudge farmers toward more diversified agroecological systems.

Even with no inherent complexity in the ecological model, and decision-making agents that simply optimize their expected utility based on current conditions, our model generates the bimodal distribution of agroecological practice adoption and ecological outcomes.  By conceiving of sustainable agricultural through this lens, we offer new insights into some agricultural policy conundrums.  

Several limitations of this model should be considered. We do not draw distinctions between diversification practices that have different cost structures or ecological outcomes. Additionally, our model does not capture market dynamics resulting from feedbacks between production and consumption, but rather conceives of the system as a commodity market within which an individual grower's production does not influence the market price.  We also do not consider ecosystem services or deleterious environmental effects that spillover from neighboring farms. However, these can all be integrated into the presented framework and offer potential avenues for future research.  


# Methods

We developed a Markov Decision Process model to represent a farmer's agroecological adoption choices over time.  The model's state space is a vector with a lower bound of 0 and a soft upper bound of 1, with the system state $s_t$ representing the degree to which the agent derives ecosystem service benefits $b_s$ from the diversification practices they have implemented on their farm.  Actions to increase investments in diversification practices probabilistically increase or decrease the future system state, with $r$ defining the rate at which the ecosystem responds to change.  While agents may stochastically transition to $s>1$, investments into diversification practices do not positively correlate with the probability of upward state transitions beyond $s=1$.

The action space is a continuous vector from 0 to 1, with $a=0$ representing no investment of resources into DP adoption or maintenance, and $a=1$ representing the highest conceivable level of investment.  Investment in diversification practices incurs costs $c_a$, either as a direct result of implementation (e.g. equipment, materials, and labor), opportunity costs (e.g. forgone yields due to reduced cultivated acreage or lost production efficiency), or both.

The time step $t$ corresponds to a single growing season.  At each time step, the agent chooses an action based on their current state by following decision strategy $\pi$.  This strategy is calculated by maximizing expected utility for each state/action pair over the full time horizon using a Stochastic Dynamic Programming (SDP) approach [@marescot2013complex], with the discount rate $\gamma$ determining how much the agent values current rewards relative to future rewards.


## Mathematical description

The farmer's decision model can be expressed as

$$\max_{\lbrace a_t \rbrace} \mathbb{E} \left[ \sum_t^T u(s_t, a_t) \gamma^t \right] $$

where $\lbrace a_t \rbrace$ is the set of available actions to be taken at each point in time $t$, $\mathbb{E}$ the expected utility operator, $u(s_t, a_t)$ the utility which the farmer associates with being in state $s_t$ and taking action $a_t$ at time $t$, and $\gamma$ the myopic discount factor. $T$ is the land tenure of the farm ($T \to \infty$ if the farmer owns the land or has a long lease).

We assume a simple model of the farmer's perceived utility, $u(s_t, a_t)$, as a function of the costs $c_a$ associated with diversification practice investment action $a_t$ at time $t$, versus benefits $b_s$ derived from ecosystem state $s_t$ at time $t$

$$u(s_t, a_t) = b_s s_t  - c_a a_t$$

The ecosystem state is also dynamic, evolving according to the transition probability function $p(s_t, a_t)$, such that

$$s_{t+1} = p(s_t, a_t) := s_t + r \left(a_t - s_t \right) + \sigma$$

This provides a minimal state transition model in which the parameter $r$ sets the natural timescale at which the ecosystem can respond to changes in land mangement, and $\sigma$ defines the spread of the state transition probability distribution, capturing the noise inherent to ecological system change.  While we have assumed very basic transition and utility functions for this stylized model, in general more complicated nonlinear functions for both the ecosystem state transition and derived utility are possible using this framework.

## Model implementation

The model was developed in the *R* programming language [@RCT2019].  The *MDPtoolbox* library was leveraged to set up and solve the MDP [@Chades2017], *tidyverse* for data analysis [@Wickham2019], and *ggplot2* to generate all figures [@Wickham2016].  Code for our model and the experiments conducted in this paper is available freely at [https://github.com/boettiger-lab/diversified-farming-systems](https://github.com/boettiger-lab/diversified-farming-systems).  

## Parameterization

We have parameterized the model to illustrate the emergence of bistability in CHANS resulting from agroecological investment decision-making given stochastic ecological responses over time.  Parameter values appear in Table \ref{tab:baseline_params}.

\begin{table}
	\centering
	\caption{Baseline parameter values}
	\begin{tabular}{lc}
		\hline
		\textbf{Parameter}			& \textbf{Value} \\
		\hline
		Benefit $b$	& 1.56 \\
		Cost $c$	& 1.00 \\
		State transition noise $\sigma$ & 0.1 \\
		State response rate $r$ & 0.1 \\
		Discount factor $\gamma$ & 0.97 \\
		\hline
	\end{tabular}
	\label{tab:baseline_params}
\end{table}


## Field observations and empirical data

To ground-truth the modeling work, our interdisciplinary research team began by investigating real-world drivers of farmers' management practices using qualitative observations of trends within a relatively-small sample.  We then evaluated these initial hypotheses using data from a larger-scale survey.

### Original interviews

We conducted interviews and on-farm observational studies of 20 organic lettuce growers and 8 technical assistance providers in California's Salinas Valley.  The sample was stratified to include growers across the spectrum of scale and market outlet.  Echoing previous research in this area, we find that adoption of diversification practices tends to be bimodal; that is, growers are likely to either intensively-adopt many DPs, or to adopt them minimally.  Participants cited decision factors including limited capital availability to implement practices with high up-front costs, food safety stipulations based on market outlet, risk attitude, and economic discounting.  Both length of time on the land and whether land is leased versus owned also emerged as salient decision criteria.

### Survey dataset

To evaluate the extent to which these observed adoption distributions hold quantitatively, we leverage a dataset of survey responses from 295 vegetable growers in Washington, Oregon, and California *CITE DATA SOURCE*.  Table \ref{tab:dps_in_survey} shows the set of DPs queried in the survey, with their adoption rates across the entire sample.  A histogram plotting the number of diversification practices used by each grower (Fig \ref{fig:res_bimodal}C) shows a bimodal distribution, with growers generally tending to either adopt zero DPs---the most likely case---or else to adopt many, with six practices being the next-most-likely.  To investigate the effect of land tenure on DP adoption, we partition the dataset into growers who primarily own their land versus those who primarily lease.  Figure \ref{fig:res_tenure}D shows that owners in our sample are about 20\% more likely than leasers to invest in at least one diversification practice.

\begin{table}
	\centering
	\caption{Diversification practices and adoption rates in the survey data}
	\begin{tabular}{lc}
		\hline
		\textbf{DP Name}			& \textbf{Adoption rate} \\
		\hline
		Crop Rotation (3 or more)	& 63\% \\
		Cover Cropping				& 68\% \\
		Intercropping				& 52\% \\
		Insectary Plantings			& 61\% \\
		Riparian Buffers			& 84\% \\
		Border Plantings			& 45\% \\
		Compost or Manure			& 75\% \\
		Reduced Tillage				& 69\% \\
		\hline
	\end{tabular}
	\label{tab:dps_in_survey}
\end{table}



# References
